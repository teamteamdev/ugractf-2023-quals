# Кто ищет, тот всегда найдёт: Write-up

Итак, нам предоставлен [access.log](attachments/access.log) веб-сервера, на котором работает [курс](https://course.ugractf.ru) Ugra CTF, что понятно как по описанию таска, так и по значительной части запросов, совершенных на сервере:

![](writeup/course-requests.png)

Предположим, что все эти запросы совершены легитимными пользователями курса, и отбросим их с помощью команды `grep`:

```
grep -v course.ugractf.ru access.log > no_course.log
```

Также можно заметить, что приличную часть запросов составляют индексирующие боты поисковых систем, сканирующие корень сайта и файл `robots.txt`. В поле User-Agent таких запросов так или иначе содержится слово `bot`:

![](writeup/bots-requests.png)

Отбросим и их:

```
grep -v -i bot no_course.log > no_course_bots.log
```
Значительно сократив количество записей в логе, попробуем всё же поискать в нём наше любимое слово `ugra`:

```
grep -i ugra no_course_bots.log
```
И в этот раз мы уже видим подозрительный запрос. В первой же строчке видно, что кто-то пытался загрузить PHP-шелл на наш сервер! 

![](writeup/grep-ugra.png)

Что интересно, шелл загружался с сервера, доменное имя которого очень похоже на ugractf.ru, только вместо буквы t используется единица. Видимо, таким образом хакер пытался замаскировать свой сайт, с которого он пытался загрузить шелл. Так разузнаем же, что на нём находится – перейдём на него.

![](writeup/hacker-site.png)

Видим сообщение, говорящее нам о том, что мы попали на домен некоего `0x55677261433146`, и что вообще нам надо с него уходить, а то не поздоровится. Вероятнее всего, это и есть наш хакер, а `0x55677261433146` — его юзернейм. Попробуем его найти.

Воспользуемся каким-нибудь из сервисов, проверяющих существование юзернейма на популярных платформах, например, [namechk.com]().

![](writeup/namechk.png)

Красным выделены платформы, на которых этот юзернейм уже занят. Попытки найти нашего хакера на таких популярных ресурсах, как Twitter, TikTok и других, не увенчались успехом, так что, видимо, это ложные срабатывания. 

Однако при проверке этого юзернейма на GitHub мы видим реально существующий профиль, на котором и спрятан флаг:

![](writeup/flag.png)

Флаг: **ugra_dont_expose_usernames_6be7ba1f**

## Постмортем

В ходе соревнований от участников поступило множество сообщений с вопросами, в правильном ли направлении они двигаются, потому что они действительно нашли что-то подозрительное или напоминающее действия хакера. Так, участниками были обнаружены:

1. Запросы от ботнетов
2. Запросы, связанные с инфраструктурой и старыми тасками [team Team]

Остановимся на каждом из пунктов поподробнее, но сперва расскажем, как так вообще получилось. 

Причина существования этих логов проста — они взяты из реального `access.log` сервера, на котором хостится наш курс. При этом лог не был как-либо отредактирован, за исключением замены IP-адресов клиентов-посетителей курса. В результате в лог и попали все эти строчки, которые могли сбить участников с толку (тем более те, которые были связаны с реальным вредоносным воздействием на инфраструктуру).

Как результат, участникам было действительно трудно найти необходимую строчку в логах, из-за чего и пришлось выкладывать целых три подсказки. С одной стороны, такой анализ логов чуть более приближен к реальности, так как зацепок в данном случае больше, чем одна, и нужно разобраться, какая из них поможет продвинуться в расследовании. С другой стороны, задача не предполагала наличие множества потенциальных зацепок, и оказалась сложнее заявленной стоимости.

Когда эта проблема обнаружилась, было принято решение не удалять эти строчки из логов, так как такой ход ставил бы в команды, решившие таск, в неравное положение с теми, кто ещё его не решил.

Посмотрим, что же было обнаружено коллективными усилиями участников.

Во-первых, в логе встречались множественные запросы от ботнетов, которые могли выглядеть ещё более подозрительно, чем запрос хакера, предложенный в таске:

![](writeup/pm-botnet.png)

Усугубило ситуацию и то, что из подобных запросов можно было получить дополнительную информацию об их отправителях. Например, base64-строка, приведённая в запросе выше, декодировалась следующим образом:

![](writeup/pm-decode.png)

Что печально, некоторых участников эти логи привели к тому, что в попытках решить таск они скачали себе вредоносное ПО. Мы им соболезнуем и надеемся на оперативную работу их антивирусных программ.

Также один из IP-адресов в таких запросах от ботнетов можно было открыть в браузере. Но так как спецслужбы не дремлют, вредоносный сайт уже не работал, а просто перенаправлял на сайт ЦРУ. Надеемся, что участник, поделившийся с нами этой находкой, не стал дальше искать хакера среди агентов Центрального разведывательного управления.

Другим тупиком, в который попадали участники, стала наша собственная инфраструктура, доменные имена которой частично присутствуют в логах. Также свою роль сыграл следующий момент: по иронии судьбы сайт хакера ugrac1f.ru и сам курс расположены на одном и том же сервере. Поэтому при сканировании сайта на открытые порты им мог попасться таск [Netcalc](https://course.ugractf.ru/ppc/task-d.html) из нашего курса, поскольку он доступен по TCP-порту 1337:

![](writeup/pm-port.png)

Ещё одним интересным кейсом является сервис Wekan. В логе пристутствует ровно один запрос, связанный с этим сервисом, причём его доменное имя закодировано в punycode, что тоже привлекает внимание. На этом сайте расположена трекинговая доска, которую мы использовали некоторое время назад. В результате на сервисе было обнаружено 6 новых пользователей. С подключением!

Помимо таких интересностей в логах, стоит упомянуть и юзернейм хакера. `0x55677261433146` действительно декодируется из хексов как `UgraC1F`, однако это не более чем пасхалка. При создании аккаунта мы не учли, что если какая-либо строка выглядит как что-то, что можно декодировать, то её обязательно декодируют и попытаются использовать. Собственно, поэтому и была дана вторая подсказка.

Такие дела.
